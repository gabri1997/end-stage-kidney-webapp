{% extends 'prediction/base.html' %}
{% load static %}

{% block title %}Dashboard - ESKD Predictor{% endblock %}

{% block extra_head %}
<style>
    
    body {
        background: 
            linear-gradient(135deg, rgba(161, 154, 154, 0.597), rgba(238, 240, 241, 0.504)),
            url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' version='1.1' xmlns:xlink='http://www.w3.org/1999/xlink' xmlns:svgjs='http://svgjs.dev/svgjs' width='1929' height='1080' preserveAspectRatio='none' viewBox='0 0 1929 1080'%3e%3cg mask='url(%26quot%3b%23SvgjsMask1221%26quot%3b)' fill='none'%3e%3crect width='1929' height='1080' x='0' y='0' fill='rgba(158%2c 177%2c 166%2c 1)'%3e%3c/rect%3e%3cpath d='M1000.284%2c400.933C1059.032%2c400.189%2c1109.229%2c360.249%2c1135.883%2c307.89C1160.208%2c260.104%2c1150.858%2c204.584%2c1123.802%2c158.289C1097.034%2c112.486%2c1053.177%2c79.952%2c1000.284%2c75.867C938.809%2c71.119%2c870.398%2c83.428%2c838.615%2c136.263C806.152%2c190.23%2c825.77%2c257.659%2c858.599%2c311.404C889.812%2c362.503%2c940.411%2c401.692%2c1000.284%2c400.933' fill='rgba(28%2c 142%2c 124%2c 0.4)' class='triangle-float3'%3e%3c/path%3e%3cpath d='M217.29358912468865 674.1919124505976L516.2746771063019 820.3676132040654 501.0490431615689 529.8452107473038z' fill='rgba(28%2c 142%2c 124%2c 0.4)' class='triangle-float3'%3e%3c/path%3e%3cpath d='M587.3608991676863 795.8220940842458L453.5601479095287 533.2233340205044 190.96138784578727 667.0240852786619 324.76213910394483 929.6228453424034z' fill='rgba(28%2c 142%2c 124%2c 0.4)' class='triangle-float2'%3e%3c/path%3e%3cpath d='M124.74486642541045 397.46481825347973L351.20601535788114 310.5345278455052 37.81457601743588 171.00366932100903z' fill='rgba(28%2c 142%2c 124%2c 0.4)' class='triangle-float1'%3e%3c/path%3e%3cpath d='M1034.2099764239435 325.9962096965058L799.6062173755386 456.03919684188116 929.6492045209139 690.6429558902862 1164.252963569319 560.5999687449107z' fill='rgba(28%2c 142%2c 124%2c 0.4)' class='triangle-float2'%3e%3c/path%3e%3cpath d='M1606.934%2c1008.7C1694.933%2c1013.251%2c1799.54%2c1014.867%2c1843.349%2c938.412C1887.042%2c862.159%2c1830.868%2c774.032%2c1783.999%2c699.689C1741.428%2c632.163%2c1686.693%2c566.659%2c1606.934%2c563.417C1522.339%2c559.978%2c1444.431%2c610.342%2c1403.045%2c684.202C1362.554%2c756.465%2c1365.321%2c845.832%2c1409.39%2c915.97C1450.869%2c981.985%2c1529.073%2c1004.673%2c1606.934%2c1008.7' fill='rgba(28%2c 142%2c 124%2c 0.4)' class='triangle-float3'%3e%3c/path%3e%3cpath d='M1982.076%2c906.321C2076.411%2c903.784%2c2159.65%2c849.72%2c2207.25%2c768.235C2255.305%2c685.972%2c2264.966%2c584.905%2c2218.381%2c501.8C2170.816%2c416.945%2c2079.315%2c363.814%2c1982.076%2c366.534C1889.042%2c369.136%2c1815.284%2c434.475%2c1767.608%2c514.407C1718.464%2c596.8%2c1688.849%2c696.777%2c1734.904%2c780.936C1782.438%2c867.798%2c1883.094%2c908.983%2c1982.076%2c906.321' fill='rgba(28%2c 142%2c 124%2c 0.4)' class='triangle-float2'%3e%3c/path%3e%3cpath d='M776.7723062063255 660.1286562514578L642.4279194867647 794.4730429710186 776.7723062063255 928.8174296905793 911.1166929258864 794.4730429710186z' fill='rgba(28%2c 142%2c 124%2c 0.4)' class='triangle-float3'%3e%3c/path%3e%3cpath d='M1143.5020642809732 75.86341734054022L929.9031700779723 204.20658113495776 1058.2463338723899 417.8054753379587 1271.8452280753907 289.4623115435411z' fill='rgba(28%2c 142%2c 124%2c 0.4)' class='triangle-float1'%3e%3c/path%3e%3cpath d='M1065.125%2c1064.403C1151.731%2c1068.41%2c1230.721%2c1015.839%2c1273.868%2c940.639C1316.81%2c865.795%2c1318.361%2c773.55%2c1274.711%2c699.117C1231.555%2c625.527%2c1150.36%2c588.299%2c1065.125%2c584.688C972.033%2c580.744%2c865.712%2c597.484%2c822.347%2c679.953C780.553%2c759.434%2c839.41%2c846.827%2c887.358%2c922.755C930.717%2c991.416%2c984.006%2c1060.65%2c1065.125%2c1064.403' fill='rgba(28%2c 142%2c 124%2c 0.4)' class='triangle-float1'%3e%3c/path%3e%3cpath d='M247.78566374738065 87.7147782072662L88.66565676423696 363.3187148027857 364.2695933597564 522.4387217859294 523.3896003429002 246.8347851904099z' fill='rgba(28%2c 142%2c 124%2c 0.4)' class='triangle-float3'%3e%3c/path%3e%3cpath d='M850.7873210785791 613.7553495547427L984.3861850130381 721.9415764218598 1092.5724118801554 588.342712487401 958.9735479456963 480.15648562028366z' fill='rgba(28%2c 142%2c 124%2c 0.4)' class='triangle-float2'%3e%3c/path%3e%3cpath d='M377.90529846533195 382.4172839843543L414.8620724160215 149.08139647568498 181.52618490735216 112.12462252499546 144.56941095666264 345.4605100336648z' fill='rgba(28%2c 142%2c 124%2c 0.4)' class='triangle-float2'%3e%3c/path%3e%3cpath d='M732.7947835814924 122.67993989162463L656.9893324458935-111.38402608942708 510.31069147076863 45.909558921241185z' fill='rgba(28%2c 142%2c 124%2c 0.4)' class='triangle-float1'%3e%3c/path%3e%3c/g%3e%3cdefs%3e%3cmask id='SvgjsMask1221'%3e%3crect width='1929' height='1080' fill='white'%3e%3c/rect%3e%3c/mask%3e%3cstyle%3e %40keyframes float1 %7b 0%25%7btransform: translate(0%2c 0)%7d 50%25%7btransform: translate(-10px%2c 0)%7d 100%25%7btransform: translate(0%2c 0)%7d %7d .triangle-float1 %7b animation: float1 5s infinite%3b %7d %40keyframes float2 %7b 0%25%7btransform: translate(0%2c 0)%7d 50%25%7btransform: translate(-5px%2c -5px)%7d 100%25%7btransform: translate(0%2c 0)%7d %7d .triangle-float2 %7b animation: float2 4s infinite%3b %7d %40keyframes float3 %7b 0%25%7btransform: translate(0%2c 0)%7d 50%25%7btransform: translate(0%2c -10px)%7d 100%25%7btransform: translate(0%2c 0)%7d %7d .triangle-float3 %7b animation: float3 6s infinite%3b %7d %3c/style%3e%3c/defs%3e%3c/svg%3e") no-repeat center center fixed;
        background-size: cover;
        background-blend-mode: overlay !important;
    }
    .box {
        background-color: rgba(240, 240, 240, 0.822);
        border-radius: 12px;
        backdrop-filter: blur(4px);
    }
    .hero-icon {
        font-size: 6rem;
        margin-left: 2rem;
        opacity: 0.95;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }

    /* Heartbeat animation */
    .hero-icon .fa-heartbeat {
        color: #f14668; /* pink/red tone */
        animation: heartbeat 1.6s ease-in-out infinite;
        transform-origin: center center;
        filter: drop-shadow(0 4px 8px rgba(241,70,104,0.12));
    }

    @keyframes heartbeat {
        0% { transform: scale(1); }
        10% { transform: scale(1.16); }
        30% { transform: scale(1); }
        50% { transform: scale(1.08); }
        70% { transform: scale(1); }
        100% { transform: scale(1); }
    }
    .hero-content {
        padding: 1rem 0;
    }
    .box:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    /* Mobile Responsive Styles */
    @media screen and (max-width: 768px) {
        .hero.is-primary {
            margin: 1rem 0.5rem !important;
            border-radius: 12px !important;
        }

        .hero-body {
            padding: 1.5rem 1rem !important;
        }

        .hero-body .columns {
            flex-direction: column;
        }

        .hero-body .column.is-narrow {
            order: -1;
            text-align: center;
            margin-bottom: 1rem;
        }

        .hero-icon {
            font-size: 4rem !important;
            margin-left: 0 !important;
        }

        .title.is-2 {
            font-size: 1.5rem !important;
            text-align: center;
        }

        .subtitle {
            font-size: 1rem !important;
            text-align: center;
        }

        /* KPI Tiles su mobile */
        .columns.is-multiline {
            margin: 0 !important;
        }

        .column.is-half {
            padding: 0.5rem !important;
        }

        .box {
            padding: 1.5rem 1rem !important;
        }

        .media-left .icon {
            margin-right: 0.75rem !important;
        }

        .media-left .fa-3x {
            font-size: 2rem !important;
        }

        .subtitle.is-2 {
            font-size: 2rem !important;
        }

        /* Azioni rapide */
        .buttons.are-medium {
            flex-direction: column;
        }

        .buttons.are-medium .button {
            width: 100%;
            margin-bottom: 0.5rem;
        }

        /* Steps */
        .steps {
            flex-direction: column !important;
        }

        .step-item {
            margin-bottom: 1.5rem;
        }

        /* Tabella predizioni su mobile */
        .table-container {
            overflow-x: auto;
        }

        table {
            min-width: 600px;
        }
    }

    /* Tablet */
    @media screen and (min-width: 769px) and (max-width: 1024px) {
        .hero-icon {
            font-size: 5rem !important;
        }
    }
</style>
{% endblock %}

{% block extra_scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const counters = document.querySelectorAll('.count-up');
    if (!counters.length) return;

    const animate = (el) => {
        const target = parseInt(el.getAttribute('data-target') || '0', 10) || 0;
        const duration = 1200;
        let start = null;

        const step = (timestamp) => {
            if (!start) start = timestamp;
            const progress = Math.min((timestamp - start) / duration, 1);
            const value = Math.floor(progress * target);
            el.textContent = value.toLocaleString();
            if (progress < 1) {
                window.requestAnimationFrame(step);
            } else {
                el.textContent = target.toLocaleString();
            }
        };

        window.requestAnimationFrame(step);
    };

    // Use IntersectionObserver so counters animate when visible
    if ('IntersectionObserver' in window) {
        const io = new IntersectionObserver((entries, obs) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    animate(entry.target);
                    obs.unobserve(entry.target);
                }
            });
        }, { threshold: 0.2 });

        counters.forEach(c => io.observe(c));
    } else {
        // Fallback: animate all immediately
        counters.forEach(animate);
    }
});
</script>
{% endblock %}

{% block content %}
<section class="hero is-primary is-bold">
    <div class="hero-body">
        <div class="container">
            <div class="columns is-vcentered">
                <div class="column hero-content">
                    <h1 class="title is-2">
                        Homepage
                    </h1>
                    <h2 class="subtitle">
                        Benvenuto nel tuo sistema di predizione ESKD
                    </h2>
                </div>
                <div class="column is-narrow">
                    <span class="icon hero-icon">
                        <i class="fas fa-heartbeat"></i>
                    </span>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="section">
    <div class="container">
        <!-- Statistiche principali -->
        <div class="columns is-multiline">
            <div class="column is-half">
                <div class="box has-background-primary-light" style="border-radius: 12px; transition: all 0.3s ease;">
                    <article class="media">
                        <div class="media-left">
                            <span class="icon is-large has-text-primary">
                                <i class="fas fa-users fa-3x"></i>
                            </span>
                        </div>
                        <div class="media-content">
                            <div class="content">
                                <h3 class="title is-4">Pazienti Totali</h3>
                                <p class="subtitle is-2"><span class="count-up" data-target="{{ num_pazienti }}">0</span></p>
                            </div>
                        </div>
                    </article>
                </div>
            </div>
            
            <div class="column is-half">
                <div class="box has-background-info-light" style="border-radius: 12px; transition: all 0.3s ease;">
                    <article class="media">
                        <div class="media-left">
                            <span class="icon is-large has-text-info">
                                <i class="fas fa-stethoscope fa-3x"></i>
                            </span>
                        </div>
                        <div class="media-content">
                            <div class="content">
                                <h3 class="title is-4">Visite Effettuate</h3>
                                <p class="subtitle is-2"><span class="count-up" data-target="{{ num_visite }}">0</span></p>
                            </div>
                        </div>
                    </article>
                </div>
            </div>
        </div>

        <!-- Azioni Rapide -->
        <div class="columns">
            <div class="column is-full">
                <div class="box">
                    <h3 class="title is-4">Azioni Rapide</h3>
                    <div class="buttons are-medium">
                        <a href="{% url 'nuovo_paziente' %}" class="button is-primary">
                            <span class="icon">
                                <i class="fas fa-user-plus"></i>
                            </span>
                            <span>Nuovo Paziente</span>
                        </a>
                        <a href="{% url 'lista_pazienti' %}" class="button is-link">
                            <span class="icon">
                                <i class="fas fa-list"></i>
                            </span>
                            <span>Lista Pazienti</span>
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ultime Predizioni -->
        <div class="columns">
            <div class="column is-full">
                <div class="box">
                    <h3 class="title is-4">
                        <span class="icon-text">
                            <span class="icon has-text-info">
                                <i class="fas fa-chart-line"></i>
                            </span>
                            <span>Ultime Predizioni</span>
                        </span>
                    </h3>
                    
                    {% if ultime_predizioni %}
                    <table class="table is-fullwidth">
                        <thead>
                            <tr>
                                <th>Paziente</th>
                                <th>Data</th>
                                <th>Esito</th>
                                <th>Probabilità</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pred in ultime_predizioni %}
                            <tr>
                                <td>
                                    <a href="{% url 'dettaglio_paziente' pred.paziente.id %}">
                                        {{ pred.paziente.cognome }} {{ pred.paziente.nome }}
                                    </a>
                                </td>
                                <td>{{ pred.data_predizione|date:"d/m/Y" }}</td>
                                <td>
                                    {% if pred.esito == 'ALTO' %}
                                        <span class="tag is-danger">Alto</span>
                                    {% elif pred.esito == 'MEDIO' %}
                                        <span class="tag is-warning">Medio</span>
                                    {% else %}
                                        <span class="tag is-success">Basso</span>
                                    {% endif %}
                                </td>
                                <td>{{ pred.probabilita_eskd|floatformat:1 }}%</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <p class="has-text-grey">Nessuna predizione effettuata</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</section>

<section class="section pt-0">
    <div class="container">
        <!-- Monitoraggio continuo + Gestione completa affiancati -->
        <div class="columns">
            <div class="column is-half">
                <div class="box has-text-centered" style="height: 100%;">
                    <span class="icon is-large has-text-primary">
                        <i class="fas fa-chart-line fa-3x"></i>
                    </span>
                    <h3 class="title is-4 mt-4">Monitoraggio Continuo</h3>
                    <p class="subtitle is-6">
                        Tieni traccia dell'evoluzione del rischio nel tempo per ogni paziente
                    </p>
                </div>
            </div>

            <div class="column is-half">
                <div class="box has-text-centered" style="height: 100%;">
                    <span class="icon is-large has-text-primary">
                        <i class="fas fa-clipboard-check fa-3x"></i>
                    </span>
                    <h3 class="title is-4 mt-4">Gestione Completa</h3>
                    <p class="subtitle is-6">
                        Gestisci visite, referti MEST-C e predizioni in un'unica piattaforma
                    </p>
                </div>
            </div>
        </div>


        <div class="box mt-6">
            <div class="content">
                <h3 class="title is-4">Come Funziona</h3>
                <div class="steps">
                    <div class="step-item">
                        <div class="step-marker">1</div>
                        <div class="step-details">
                            <p class="step-title">Inserisci i Dati del Paziente</p>
                            <p>Registra le informazioni anagrafiche e cliniche del paziente</p>
                        </div>
                    </div>
                    <div class="step-item">
                        <div class="step-marker">2</div>
                        <div class="step-details">
                            <p class="step-title">Aggiungi i Referti MEST-C</p>
                            <p>Inserisci i risultati dell'analisi istologica</p>
                        </div>
                    </div>
                    <div class="step-item">
                        <div class="step-marker">3</div>
                        <div class="step-details">
                            <p class="step-title">Ottieni la Predizione</p>
                            <p>Il sistema calcolerà automaticamente il rischio di ESKD</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<style>
    .steps {
        display: flex;
        justify-content: space-between;
        margin: 2rem 0;
    }
    .step-item {
        flex: 1;
        text-align: center;
        padding: 1rem;
    }
    .step-marker {
        width: 3rem;
        height: 3rem;
        border-radius: 50%;
        background-color: #00d1b2;
        color: white;
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 1rem;
    }
    .step-title {
        font-weight: bold;
        margin-bottom: 0.5rem;
    }

    .hero.is-primary {
        background: linear-gradient(135deg, #59aea1 0%, #73afa6 100%) !important;
        color: white !important;
        border-radius: 20px;
        box-shadow: 0 8px 20px rgba(255, 255, 255, 0.493);
        margin: 2rem auto;  
        width: 100%;
        color: #f14668 !important; /* testo blu scuro per contrasto */
    }

    .hero img {
        max-height: 400px;
        margin: 0 auto;
    }
</style>
{% endblock %}